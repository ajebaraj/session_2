<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Selector & Upload Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"/>
</head>
<body>
  <div class="toggle-btn" id="themeToggle">‚òÄÔ∏è</div>

  <div class="dashboard">
    <!-- Animal Selector -->
    <div class="card">
      <h2>Select an Animal</h2>
      <div class="animal-options">
        <div class="animal-option" data-animal="cat">üê± Cat</div>
        <div class="animal-option" data-animal="dog">üê∂ Dog</div>
        <div class="animal-option" data-animal="elephant">üêò Elephant</div>
      </div>
      <div id="animalPreview">Pick an animal...</div>
    </div>

    <!-- File Upload -->
    <div class="card">
      <h2>Upload Files</h2>
      <div id="dropzone" class="dropzone">
        Drag & drop or click to choose
        <input id="fileInput" type="file"/>
      </div>
      <div id="uploadList"></div>
      <h3>Result:</h3>
      <div id="output" class="kv-output"></div>
      <h3>Preview:</h3>
      <div id="preview"></div>
    </div>

    <!-- Upload History -->
    <div class="card span-2">
      <h2>Upload History</h2>
      <ul class="history-list" id="history"></ul>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script>
    const dropzone = document.getElementById("dropzone");
    const fileInput = document.getElementById("fileInput");
    const uploadList = document.getElementById("uploadList");
    const output = document.getElementById("output");
    const preview = document.getElementById("preview");
    const animalPreview = document.getElementById("animalPreview");
    const toastContainer = document.getElementById("toastContainer");
    const themeToggle = document.getElementById("themeToggle");
    const historyList = document.getElementById("history");
    let history = [];

    // Theme toggle
    function setTheme(light) {
      if (light) { document.body.classList.add("light"); themeToggle.textContent="üåô"; localStorage.setItem("theme","light"); }
      else { document.body.classList.remove("light"); themeToggle.textContent="‚òÄÔ∏è"; localStorage.setItem("theme","dark"); }
    }
    themeToggle.onclick = ()=> setTheme(!document.body.classList.contains("light"));
    if (localStorage.getItem("theme")==="light") setTheme(true);

    // Toast helper
    function showToast(msg) {
      const toast=document.createElement("div");
      toast.className="toast";
      toast.textContent=msg;
      toastContainer.appendChild(toast);
      setTimeout(()=>toast.remove(),3000);
    }

    // Animal selector
    document.querySelectorAll(".animal-option").forEach(opt=>{
      opt.addEventListener("click",()=>{
        document.querySelectorAll(".animal-option").forEach(o=>o.classList.remove("active"));
        opt.classList.add("active");
        const animal=opt.dataset.animal;
        animalPreview.innerHTML=`<img src="/static/images/${animal}.jpg" class="preview">`;
        showToast(`${animal} selected üêæ`);
      });
    });

    // Upload
    dropzone.addEventListener("click",()=> fileInput.click());
    dropzone.addEventListener("dragover",e=>{ e.preventDefault(); dropzone.style.borderColor="#4cafef"; });
    dropzone.addEventListener("dragleave",()=> dropzone.style.borderColor="#666");
    dropzone.addEventListener("drop",e=>{
      e.preventDefault(); dropzone.style.borderColor="#666";
      [...e.dataTransfer.files].forEach(f=>uploadFile(f));
    });
    fileInput.addEventListener("change",()=> {
      [...fileInput.files].forEach(f=>uploadFile(f));
    });

    function uploadFile(file){
      const item=document.createElement("div");
      item.className="file-item";
      item.innerHTML=`<strong>${file.name}</strong><div class="bar"><div></div></div>`;
      uploadList.appendChild(item);
      const bar=item.querySelector(".bar div");
        // Hide animal preview when a file is uploaded
      animalPreview.innerHTML = "";
      document.querySelectorAll(".animal-option").forEach(o => o.classList.remove("active"));

      const form=new FormData();
      form.append("file",file);

      const xhr=new XMLHttpRequest();
      xhr.open("POST","/upload");
      xhr.upload.onprogress=(e)=>{ if(e.lengthComputable){ bar.style.width=(e.loaded/e.total*100)+"%"; }};
      xhr.onload=()=>{
        try {
          const data=JSON.parse(xhr.responseText);
          output.innerHTML = `
            <div class="row"><span class="k">Filename:</span> <span class="v">${data.filename}</span></div>
            <div class="row"><span class="k">Type:</span> <span class="v">${data.type}</span></div>
            <div class="row"><span class="k">Size:</span> <span class="v">${data.size} (${data.size_bytes} bytes)</span></div>
            <div class="row"><span class="k">Message:</span> <span class="v">${data.message || "‚Äî"}</span></div>
          `;
          showToast(data.message || "Upload complete ‚úÖ");

          // Update preview
          preview.innerHTML="";
          if(data.type.startsWith("image/")){
            const img=document.createElement("img");
            img.src="/uploads/"+data.filename;
            img.className="preview";
            preview.appendChild(img);
          } else if(data.type.startsWith("text/") || data.filename.endsWith(".py")){
            fetch("/uploads/"+data.filename).then(r=>r.text()).then(t=>{
              preview.innerHTML=`<pre><code class="language-js">${t.split("\n").slice(0,15).join("\n")}</code></pre>`;
              Prism.highlightAll();
            });
          } else {
            preview.textContent="üìÑ "+data.type;
          }

          // Add to history
          history.unshift(data);
          if(history.length>5) history.pop();
          renderHistory();
        } catch(e){
          showToast("Upload failed ‚ùå");
        }
      };
      xhr.onerror=()=>showToast("Network error ‚ùå");
      xhr.send(form);
    }

    function renderHistory(){
      historyList.innerHTML="";
      history.forEach(f=>{
        const li=document.createElement("li");
        li.innerHTML=`${f.filename} (${f.size}) <a href="/uploads/${f.filename}" target="_blank">Download</a>`;
        historyList.appendChild(li);
      });
    }
  </script>
</body>
</html>
